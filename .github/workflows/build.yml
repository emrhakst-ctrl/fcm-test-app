name: Build APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Java 17
      id: setup-java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Export JAVA_HOME for following steps
      run: echo "JAVA_HOME=${{ steps.setup-java.outputs.java-home }}" >> $GITHUB_ENV

    - name: Verify Java
      run: |
        echo "JAVA_HOME=$JAVA_HOME"
        java -version
        which java

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          wget unzip zip \
          build-essential git \
          libssl-dev libffi-dev \
          zlib1g-dev libbz2-dev \
          autoconf libtool \
          pkg-config cmake ccache

  - name: Setup Android SDK
    run: |
      # Ensure we use the Java we installed
      export PATH="$JAVA_HOME/bin:$PATH"
  
      # set SDK root where we'll install cmdline-tools and packages
      export ANDROID_SDK_ROOT=$HOME/android-sdk
      mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
      cd $ANDROID_SDK_ROOT/cmdline-tools
  
      # download & extract command line tools
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
      unzip -q commandlinetools-linux-9477386_latest.zip
      # ensure the layout is $ANDROID_SDK_ROOT/cmdline-tools/latest/{bin,...}
      mv cmdline-tools latest
  
      # make sdkmanager available
      export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
  
      # debug info
      echo "Using java at: $(which java)"
      java -version
      sdkmanager --version || true
  
      # accept licenses (non-interactive)
      yes | sdkmanager --sdk_root=${ANDROID_SDK_ROOT} --licenses || true
  
      # explicitly install required packages (match the build-tools version your logs expect)
      sdkmanager --sdk_root=${ANDROID_SDK_ROOT} "platform-tools" "platforms;android-33" "build-tools;36.1.0"
  
      # create symlink so buildozer finds the SDK where it expects it
      mkdir -p $HOME/.buildozer/android/platform
      ln -sfn ${ANDROID_SDK_ROOT} $HOME/.buildozer/android/platform/android-sdk
  
      # export for later steps
      echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV
      echo "${ANDROID_SDK_ROOT}/platform-tools" >> $GITHUB_PATH
      echo "${ANDROID_SDK_ROOT}/build-tools/36.1.0" >> $GITHUB_PATH

    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer cython==0.29.33

    - name: Build APK
      run: |
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: prayer-test-apk
        path: bin/*.apk
        retention-days: 7

    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: buildozer-logs
        path: .buildozer/
        retention-days: 2
