from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button
from kivy.clock import Clock
import requests

class FCMTestApp(App):
    player_id = None  # OneSignal kullanıcı ID'si
    
    def build(self):
        layout = BoxLayout(orientation='vertical', padding=20, spacing=10)
        
        self.status_label = Label(
            text='OneSignal FCM Test\\n\\nHazir!',
            size_hint=(1, 0.6),
            halign='center',
            valign='middle',
            font_size='16sp'
        )
        self.status_label.bind(size=self.status_label.setter('text_size'))
        
        init_btn = Button(
            text='OneSignal Baslat',
            size_hint=(1, 0.1),
            font_size='18sp'
        )
        init_btn.bind(on_press=self.init_onesignal)
        
        register_btn = Button(
            text='Backend Kayit',
            size_hint=(1, 0.1),
            font_size='18sp'
        )
        register_btn.bind(on_press=self.register_backend)
        
        instant_btn = Button(
            text='Aninda Bildirim',
            size_hint=(1, 0.1),
            font_size='18sp'
        )
        instant_btn.bind(on_press=lambda x: self.test_notif('instant'))
        
        delayed_btn = Button(
            text='10 Saniye Sonra',
            size_hint=(1, 0.1),
            font_size='18sp'
        )
        delayed_btn.bind(on_press=lambda x: self.test_notif('10s'))
        
        layout.add_widget(self.status_label)
        layout.add_widget(init_btn)
        layout.add_widget(register_btn)
        layout.add_widget(instant_btn)
        layout.add_widget(delayed_btn)
        
        return layout
    
    def init_onesignal(self, instance):
        """OneSignal başlat"""
        self.status_label.text = 'OneSignal baslatiliyor...'
        
        def _init():
            try:
                from jnius import autoclass
                
                # OneSignal başlat
                OneSignal = autoclass('com.onesignal.OneSignal')
                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                
                activity = PythonActivity.mActivity
                
                # ONESIGNAL APP ID'NİZİ YAZIN!
                ONESIGNAL_APP_ID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                
                OneSignal.setLogLevel(6, 0)  # Debug mode
                OneSignal.initWithContext(activity)
                OneSignal.setAppId(ONESIGNAL_APP_ID)
                
                # Player ID al (kullanıcı kimliği)
                device_state = OneSignal.getDeviceState()
                self.player_id = str(device_state.getUserId())
                
                short = self.player_id[:50] + "..."
                self.status_label.text = f'OneSignal hazir!\\n\\n{short}\\n\\n"Backend Kayit" yapin'
                
            except Exception as e:
                self.status_label.text = f'Hata: {str(e)[:100]}'
        
        Clock.schedule_once(lambda dt: _init(), 0.5)
    
    def register_backend(self, instance):
        """Backend'e kayıt"""
        if not self.player_id:
            self.status_label.text = 'Once OneSignal baslatın!'
            return
        
        self.status_label.text = 'Backend kayit yapiliyor...'
        
        def _register():
            try:
                # KENDİ IP ADRESİNİZİ YAZIN!
                url = "http://192.168.1.6:8000/register"
                
                response = requests.post(
                    url,
                    json={"player_id": self.player_id},
                    timeout=5
                )
                
                if response.status_code == 200:
                    data = response.json()
                    self.status_label.text = f'Kayit basarili!\\nToplam: {data.get("total_devices")}'
                else:
                    self.status_label.text = f'Hata: {response.status_code}'
                    
            except Exception as e:
                self.status_label.text = f'Baglanti hatasi:\\n{str(e)[:80]}'
        
        Clock.schedule_once(lambda dt: _register(), 0.1)
    
    def test_notif(self, test_type):
        """Test bildirimi"""
        self.status_label.text = f'{test_type} bildirimi gonderiliyor...'
        
        def _send():
            try:
                url = f"http://192.168.1.6:8000/test/{test_type}"
                
                response = requests.post(url, timeout=5)
                
                if response.status_code == 200:
                    data = response.json()
                    if test_type == 'instant':
                        self.status_label.text = 'Bildirim gonderildi!'
                    else:
                        self.status_label.text = f'Zamanlandi\\n{data.get("scheduled_time")}'
                else:
                    self.status_label.text = f'Hata: {response.status_code}'
                    
            except Exception as e:
                self.status_label.text = f'Hata:\\n{str(e)[:80]}'
        
        Clock.schedule_once(lambda dt: _send(), 0.1)

if __name__ == '__main__':
    FCMTestApp().run()
